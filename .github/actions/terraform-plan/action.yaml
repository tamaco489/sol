name: Execute terraform plan
description: |
  å®Ÿè¡Œå¯¾è±¡ã®ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã§terraform planã‚’å®Ÿè¡Œã™ã‚‹ã€‚

inputs:
  aws_account_id:
    description: "AWSã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ID"
    required: true
  terraform_env:
    description: "å®Ÿè¡Œå¯¾è±¡ã®terraform ç’°å¢ƒ(stg/prd)"
    required: true
  working_directory:
    description: "å®Ÿè¡Œãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒª"
    required: true
  github_token:
    description: "PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¨­å®šã™ã‚‹ãŸã‚ã®ãƒˆãƒ¼ã‚¯ãƒ³ â€»e.g `secrets.GITHUB_TOKEN` ã§å‚ç…§ã™ã‚‹"
    required: true

runs:
  using: "composite"
  steps:
    - uses: ./.github/actions/terraform-install
      with:
        target_directory: ${{ inputs.working_directory }}

    - uses: ./.github/actions/aws-credential
      with:
        aws_account_id: ${{ inputs.aws_account_id }}
        terraform_env: ${{ inputs.terraform_env }}

    - name: Terraform Init
      shell: bash
      run: terraform init -reconfigure -backend-config="./tfbackend/${{ inputs.terraform_env }}.tfbackend"
      working-directory: ${{ inputs.working_directory }}

    # NOTE: terraform planã®å®Ÿè¡Œ
    - name: Terraform Plan
      shell: bash
      id: plan
      run: |
        echo ${{ inputs.working_directory }}
        terraform plan -detailed-exitcode -no-color -input=false -var-file="./tfvars/${{ inputs.terraform_env }}.tfvars"
      # DOC: -detailed-exitcode: 0=å·®åˆ†ãŒãªã„, 1=å·®åˆ†ãŒã‚ã‚‹ , 2=ã‚¨ãƒ©ãƒ¼
      # DOC: -no-color         : è‰²ã‚’å‡ºåŠ›ã—ãªã„
      # DOC: -input=false      : å¯¾è©±å‹å…¥åŠ›ã‚’ç„¡åŠ¹åŒ–

      working-directory: ${{ inputs.working_directory }}

      # jobå†…ã®ç‰¹å®šã®stepãŒã‚¨ãƒ©ãƒ¼ã§çµ‚äº†ã—ãŸå ´åˆã§ã‚‚ã€å…¨ä½“ã®jobã¯çµ‚äº†ã•ã›ãšå¾Œç¶šã®stepã‚’å®Ÿè¡Œã™ã‚‹
      continue-on-error: true

    # NOTE: terraform planã®çµæœã‚’PRã«ã‚³ãƒ¡ãƒ³ãƒˆã™ã‚‹
    - uses: actions/github-script@v7
      # PRã«å¯¾ã—ã¦ã®ã¿ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ ã™ã‚‹
      if: always() && ${{ github.event.issue.pull_request }}

      # terraform planã®çµæœã‚’ç’°å¢ƒå¤‰æ•°ã«è¨­å®š
      env:
        PLAN_STDOUT: ${{ steps.plan.outputs.stdout }}
        PLAN_STDERR: ${{ steps.plan.outputs.stderr }}

      # PRã«ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¿½åŠ 
      # DOC: [Marketplace] https://github.com/marketplace/actions/github-script
      # DOC: [github] https://github.com/actions/github-script
      with:
        github-token: ${{ inputs.github_token }}
        script: |
          const output = `#### Terraform Plan(${{ inputs.terraform_env }}) ğŸ“–\`${{ steps.plan.outcome }}\`
          Working Directory: \`${{ inputs.working_directory }}\`
          <details><summary>Show Plan</summary>

          \`\`\`hcl\n
          ${process.env.PLAN_STDOUT}
          ${process.env.PLAN_STDERR}
          \`\`\`

          </details>`;

          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })

    # NOTE: terraform planãŒå¤±æ•—ã—ãŸå ´åˆã€jobã‚’å¤±æ•—ã•ã›ã¦å¾Œç¶šã®å‡¦ç†ã‚’ä¸­æ–­ã™ã‚‹
    - name: Exit on plan failures
      shell: bash
      if: steps.plan.outcome != 'success'
      run: |
        echo "Failed to terraform plan"
        exit 1

